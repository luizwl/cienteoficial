<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Clientes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f8ff;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1, h3 {
            text-align: center;
            color: #0066cc;
        }

        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background-color: #0066cc;
            color: #fff;
            padding: 10px 20px;
            margin: 5px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #004d99;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            display: none; /* Inicialmente a tabela √© oculta */
        }

        th, td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
        }

        .avisado {
            background-color: #007bff !important; /* Azul */
        }

        .avisado {
            background-color: #add8e6;
        }

        .debito {
            background-color: #ffa500 !important;
        }

        .vencendo-hoje {
            background-color: #ffff99; /* Amarelo claro para vencendo hoje */
        }

        .vencido {
            background-color: #ff6666; /* Vermelho claro para vencidos */
        }

        .center {
            text-align: center;
        }

        /* Estilos para o Modal */
    .modal {
    display: none; /* Inicialmente o modal est√° oculto */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Fundo escuro semitransparente */
    justify-content: center;
    align-items: center;
}

    .modal-content {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    width: 300px;
}

    .modal button {
    background-color: #0066cc;
    color: #fff;
    padding: 10px 20px;
    margin: 5px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

    .modal button:hover {
    background-color: #004d99;
}


    </style>
</head>

<body>
    <div class="container">
        <h1>Controle de Clientes</h1>
        <!-- Bot√µes de Importar/Exportar -->
        <button onclick="importarClientes()">Importar Clientes (JSON)</button>
        <button onclick="exportarClientes()">Exportar Clientes (JSON)</button>
        
        <h3>Adicionar Cliente</h3>
<input type="date" id="dataInput" required>
<input type="text" id="nomeInput" placeholder="Nome do Cliente" required>
<input type="tel" id="telefoneInput" placeholder="Telefone (ex: 11999999999)" required>

<!-- Novo campo para sele√ß√£o do Produto -->
<div>
    <label>
        <input type="radio" name="produto" value="UniTv" checked> UniTv
    </label>
    <label>
        <input type="radio" name="produto" value="Duplecast"> Duplecast
    </label>
</div>

<button onclick="adicionarCliente()">Adicionar Cliente</button>


        
        
        <h3>Filtros</h3>
        <button onclick="filtrarHoje()">Clientes Vencendo Hoje</button>
        <button onclick="filtrarAmanha()">Clientes Vencendo Amanh√£</button>
        <button onclick="filtrarVencidos()">Clientes Vencidos</button>
        <button onclick="filtrarDebito()">Clientes com D√©bito</button>
        <button onclick="exibirTodos()">Reexibir Todos</button>
        <button onclick="limparTodos()">Limpar Todos</button>
        <button onclick="desfazer()">Desfazer √öltima A√ß√£o</button>
        <button onclick="desfazer()">Arquivados</button>
        
        <table>
            <thead>
                <tr>
                    <th>Data de Vencimento</th>
                    <th>Nome</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tabelaClientes"></tbody>
        </table>
        
        <button onclick="salvarArquivo()">Salvar no Pr√≥prio HTML</button>
        <button onclick="compartilharWhatsApp()">Compartilhar no WhatsApp</button>
        
        <h3>Data Atual</h3>
        <p id="dataAtual"></p>
        <!-- Modal de Confirma√ß√£o -->
    <div id="modalConfirmacao" class="modal">
    <div class="modal-content">
        <h3>Confirmar Duplica√ß√£o</h3>
        <p>Voc√™ tem certeza que deseja duplicar este cliente?</p>
        <button onclick="confirmarDuplicacao()">Confirmar</button>
        <button onclick="fecharModal()">Cancelar</button>
    </div>
</div>

<div>
    <label>
        <input type="radio" name="produto" value="UniTv" checked> UniTv
    </label>
    <label>
        <input type="radio" name="produto" value="Duplecast"> Duplecast
    </label>
</div>

<div id="modalExclusao" class="modal">
    <div class="modal-content">
        <h3>Confirmar Exclus√£o</h3>
        <p>Voc√™ tem certeza que deseja excluir este cliente?</p>
        <button onclick="confirmarExclusao()">Confirmar</button>
        <button onclick="fecharModal()">Cancelar</button>
    </div>
</div>


    </div>

    <script>
        let clientes = JSON.parse(localStorage.getItem('clientes')) || [];
        let ultimaAcao = null;
        let clientesFiltrados = [];
        let clienteIndexParaExcluir = null;

        function adicionarCliente() {
    const dataInput = document.getElementById("dataInput").value.trim();
    const nomeInput = document.getElementById("nomeInput").value.trim();
    const telefoneInput = document.getElementById("telefoneInput").value.trim();
    const produtoSelecionado = document.querySelector('input[name="produto"]:checked').value; // Pega o produto selecionado

    if (!dataInput || !nomeInput || !telefoneInput) {
        return alert("Por favor, insira a data, o nome e o telefone do cliente.");
    }

    const dataParts = dataInput.split("-");
    const dataFormatada = `${dataParts[2]}/${dataParts[1]}/${dataParts[0]}`;
    const telefoneLimpo = telefoneInput.replace(/[^\d]/g, '');

    clientes.push({ 
        data: dataFormatada, 
        nome: nomeInput, 
        telefone: telefoneLimpo, 
        avisado: false, 
        debito: false, 
        Produto: produtoSelecionado // Adiciona o produto
    });

    document.getElementById("dataInput").value = "";
    document.getElementById("nomeInput").value = "";
    document.getElementById("telefoneInput").value = "";

    exibirTabela();
    salvarClientes();
}

    function duplicarCliente(index) {
    const cliente = clientes[index];
    const novoCliente = { 
        data: cliente.data,
        nome: cliente.nome,
        telefone: cliente.telefone,
        avisado: cliente.avisado,
        debito: cliente.debito
    };
    // Adiciona o novo cliente
    clientes.push(novoCliente);
    exibirTabela();
    salvarClientes();
}

function renovarAutomatico(index) {
    const cliente = clientesFiltrados.length > 0 ? clientesFiltrados[index] : clientes[index];

    // Garante que tanto "Produto" quanto "produto" sejam considerados
    const produtoCliente = cliente.Produto || cliente.produto || "N√£o informado";

    if (produtoCliente === "N√£o informado") {
        exibirAlerta("O produto do cliente n√£o est√° informado!");
        return;
    }

    if (produtoCliente === "Duplecast") {
        renovarProximoMes(index);
    } else if (produtoCliente === "UniTv") {
        renovar30(index);
    }
}

// Fun√ß√£o para exibir alerta que fecha com ESC ou ENTER
function exibirAlerta(mensagem) {
    let modal = document.createElement("div");
    modal.id = "modalAlerta";
    modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center;">
            <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; width: 300px;">
                <h3>Aviso</h3>
                <p>${mensagem}</p>
                <button onclick="fecharAlerta()">OK</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // Fechar alerta com ESC ou ENTER
    document.addEventListener("keydown", fecharComEscOuEnter);
}

function fecharAlerta() {
    let modal = document.getElementById("modalAlerta");
    if (modal) {
        document.body.removeChild(modal);
        document.removeEventListener("keydown", fecharComEscOuEnter);
    }
}

// Fun√ß√£o para fechar o alerta com ESC ou ENTER
function fecharComEscOuEnter(event) {
    if (event.key === "Escape" || event.key === "Enter") {
        fecharAlerta();
    }
}

// Fun√ß√£o para renovar 30 dias
function renovar30(index) {
    const cliente = clientesFiltrados.length > 0 ? clientesFiltrados[index] : clientes[index];
    cliente.data = incrementarData(cliente.data, 30);
    if (clientesFiltrados.length > 0) clientesFiltrados.splice(index, 1);
    exibirTabela();
    salvarClientes();
}

// Fun√ß√£o para renovar para o pr√≥ximo m√™s
function renovarProximoMes(index) {
    const cliente = clientesFiltrados.length > 0 ? clientesFiltrados[index] : clientes[index];
    const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));
    const dataObj = new Date(ano, mes - 1, dia);

    dataObj.setMonth(dataObj.getMonth() + 1);
    
    if (dataObj.getDate() !== dia) {
        dataObj.setDate(0);
    }

    cliente.data = `${dataObj.getDate().toString().padStart(2, '0')}/${(dataObj.getMonth() + 1).toString().padStart(2, '0')}/${dataObj.getFullYear()}`;
    
    if (clientesFiltrados.length > 0) clientesFiltrados.splice(index, 1);
    exibirTabela();
    salvarClientes();
}

// Fun√ß√£o auxiliar para incrementar data
function incrementarData(data, dias) {
    const [dia, mes, ano] = data.split("/").map(num => parseInt(num));
    const dataObj = new Date(ano, mes - 1, dia);
    dataObj.setDate(dataObj.getDate() + dias);
    return `${dataObj.getDate().toString().padStart(2, '0')}/${(dataObj.getMonth() + 1).toString().padStart(2, '0')}/${dataObj.getFullYear()}`;
}


// Confirmar exclus√£o com Enter
document.addEventListener('keydown', function(event) {
    if (event.key === "Enter" && document.getElementById("modalConfirmacao").style.display === "flex") {
        confirmarExclusao();
    }
});
let clienteIndexParaDuplicar = null;  // Vari√°vel para armazenar o √≠ndice do cliente a ser duplicado

// Fun√ß√£o chamada ao clicar no bot√£o "+"
function duplicarCliente(index) {
    clienteIndexParaDuplicar = index;  // Armazenar o √≠ndice do cliente
    document.getElementById("modalConfirmacao").style.display = "flex";  // Exibe o modal
}

// Fun√ß√£o para fechar qualquer modal
function fecharModal() {
    document.getElementById("modalDuplicacao").style.display = "none";
    document.getElementById("modalExclusao").style.display = "none";
}

// Confirmar exclus√£o
function confirmarExclusao() {
    if (clienteIndexParaExcluir !== null) {
        let clienteRemovido = clientesFiltrados.length > 0 
            ? clientesFiltrados[clienteIndexParaExcluir] 
            : clientes[clienteIndexParaExcluir];

        // Remove o cliente da lista principal `clientes`
        clientes = clientes.filter(c => !(c.nome === clienteRemovido.nome && c.data === clienteRemovido.data));

        // Se um filtro estiver ativo, remove tamb√©m da lista filtrada
        if (clientesFiltrados.length > 0) {
            clientesFiltrados.splice(clienteIndexParaExcluir, 1);
        }

        // Atualiza a exibi√ß√£o da tabela
        exibirTabela();
        salvarClientes();

        // Fecha o modal de exclus√£o
        fecharModalExclusao();
        
        // Reseta a vari√°vel
        clienteIndexParaExcluir = null;
    }
}

// Fun√ß√£o para fechar o modal de exclus√£o
function fecharModalExclusao() {
    document.getElementById("modalExclusao").style.display = "none"; 
}

// Adiciona evento para fechar com ESC e confirmar com ENTER
document.addEventListener("keydown", function(event) {
    let modalAberto = document.getElementById("modalExclusao").style.display === "flex";

    if (modalAberto) {
        if (event.key === "Escape") {
            fecharModalExclusao(); // Fecha o modal ao pressionar ESC
        }
        if (event.key === "Enter") {
            confirmarExclusao(); // Confirma a exclus√£o ao pressionar ENTER
        }
    }
});

// Fun√ß√£o para fechar o modal de exclus√£o
function fecharModalExclusao() {
    document.getElementById("modalExclusao").style.display = "none"; 
}

// Evento para fechar o modal com ESC e confirmar com ENTER
document.addEventListener("keydown", function(event) {
    let modalAberto = document.getElementById("modalExclusao").style.display === "flex";

    if (modalAberto) {
        if (event.key === "Escape") {
            fecharModalExclusao(); // Fecha o modal ao pressionar ESC
        }
        if (event.key === "Enter") {
            confirmarExclusao(); // Confirma a exclus√£o ao pressionar ENTER
        }
    }
});


// Fun√ß√£o para confirmar a duplica√ß√£o do cliente
function confirmarDuplicacao() {
    const cliente = clientes[clienteIndexParaDuplicar];
    const novoCliente = { 
        data: cliente.data,
        nome: cliente.nome,
        telefone: cliente.telefone,
        avisado: cliente.avisado,
        debito: cliente.debito
    };
    // Adiciona o novo cliente
    clientes.push(novoCliente);
    exibirTabela();
    salvarClientes();
    fecharModal();  // Fecha o modal ap√≥s a duplica√ß√£o
}

function ordenarPorData() {
    clientes.sort((a, b) => {
        const [diaA, mesA, anoA] = a.data.split("/").map(num => parseInt(num));
        const [diaB, mesB, anoB] = b.data.split("/").map(num => parseInt(num));

        const dataA = new Date(anoA, mesA - 1, diaA);
        const dataB = new Date(anoB, mesB - 1, diaB);

        return dataA - dataB;
    });

    exibirTabela(); // Atualiza a tabela ap√≥s a ordena√ß√£o
}


        function exibirTabela() {
    let listaParaExibir = clientesFiltrados.length > 0 ? clientesFiltrados : clientes;
    
    if (listaParaExibir.length === 0) {
        document.querySelector("table").style.display = "none";
        return;
    }

    document.querySelector("table").style.display = "table";
    
    // Atualiza o cabe√ßalho com a quantidade de clientes
    document.querySelector("thead").innerHTML = `
        <tr>
            <th>Data de Vencimento</th>
            <th>Nome (${listaParaExibir.length})</th>
            <th>A√ß√µes</th>
        </tr>
    `;

    const tabela = document.getElementById("tabelaClientes");
    tabela.innerHTML = "";

    listaParaExibir.forEach((cliente, index) => {
        const tr = document.createElement("tr");
        tr.className = cliente.avisado ? "avisado" : cliente.debito ? "debito" : "";

        tr.innerHTML = `
    <td>${cliente.data}</td>
    <td>
        <a href="javascript:void(0);" onclick="enviarMensagemWhatsApp('${cliente.nome}', '${cliente.telefone}')">${cliente.nome}</a>
        <button title="Duplicar Cliente" onclick="duplicarCliente(${index})">+</button>
        <button title="Copiar Mensagem" style="background-color: green;" onclick="copiarMensagem(${index})">üìã</button>
    </td>
    <td>
        <button title="Renovar Autom√°tico" onclick="renovarAutomatico(${index})">üîÅ</button>
        <button title="Marcar/Desmarcar Avisado" onclick="toggleAvisado(${index})">${cliente.avisado ? "Desmarcar Avisado" : "Marcar Avisado"}</button>
        <button title="Marcar/Desmarcar D√©bito" onclick="toggleDebito(${index})">${cliente.debito ? "Desmarcar D√©bito" : "Marcar D√©bito"}</button>
        <button title="Editar Cliente" onclick="editar(${index})">Edit</button>
        <button title="Excluir Cliente" onclick="excluir(${index})">‚ùå</button>
        <button title="Arquivar Cliente" onclick="arquivar(${index})">üìÇ</button>
    </td>
`;

        tabela.appendChild(tr);
    });
}

function enviarMensagemWhatsApp(clienteNome, clienteTelefone) {
    const telefoneLimpo = clienteTelefone.replace(/\D/g, ''); // Remove tudo que n√£o for n√∫mero

    const dataAtual = new Date();
    const hora = dataAtual.getHours();

    let saudacao = "Ol√°"; 
    if (hora >= 6 && hora < 12) {
        saudacao = "Bom dia";
    } else if (hora >= 12 && hora < 18) {
        saudacao = "Boa tarde";
    } else {
        saudacao = "Boa noite";
    }

    const mensagem = `
*${saudacao}*! 
Hoje √© o vencimento do seu plano de TV.

*Vencimento*: ${dataAtual.toLocaleDateString('pt-BR')}

O pagamento via PIX pode ser realizado no n√∫mero: 
*11950912509* (Waldemar Jose Luiz)
`;

    const url = `https://wa.me/${telefoneLimpo}?text=${encodeURIComponent(mensagem)}`;
    window.open(url, '_blank');
}




function exportarClientes() {
    const clientesCompletos = clientes.map(cliente => ({
        data: cliente.data,
        nome: cliente.nome,
        telefone: cliente.telefone,
        avisado: cliente.avisado,
        debito: cliente.debito,
        Produto: cliente.Produto || "N√£o informado" // Garante que o campo Produto sempre esteja presente
    }));

    const clientesJson = JSON.stringify(clientesCompletos, null, 4);
    const blob = new Blob([clientesJson], { type: "application/json" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "clientes.json";
    link.click();
}


        function filtrarHoje() {
    const hoje = new Date();
    const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" +
                          (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +
                          hoje.getFullYear();

    clientesFiltrados = clientes.filter(cliente => cliente.data === hojeFormatada);

    const tabela = document.getElementById("tabelaClientes");
    tabela.innerHTML = ""; // Limpa a tabela antes de exibir novos dados

    if (clientesFiltrados.length === 0) {
        tabela.innerHTML = `<tr><td colspan="3" style="text-align: center; font-weight: bold; color: red;">Nenhum cliente vencendo hoje.</td></tr>`;
    } else {
        exibirTabela(); // Exibe os clientes normalmente
    }
}


function filtrarAmanha() {
    const amanha = new Date();
    amanha.setDate(amanha.getDate() + 1); // Adiciona 1 dia para pegar a data de amanh√£
    const amanhaFormatada = amanha.getDate().toString().padStart(2, '0') + "/" +
                            (amanha.getMonth() + 1).toString().padStart(2, '0') + "/" +
                            amanha.getFullYear();

    clientesFiltrados = clientes.filter(cliente => cliente.data === amanhaFormatada);

    const tabela = document.getElementById("tabelaClientes");
    tabela.innerHTML = ""; // Limpa a tabela antes de exibir novos dados

    if (clientesFiltrados.length === 0) {
        tabela.innerHTML = `<tr><td colspan="3" style="text-align: center; font-weight: bold; color: orange;">Nenhum cliente vencendo amanh√£.</td></tr>`;
    } else {
        exibirTabela(); // Exibe os clientes normalmente
    }
}


        function filtrarVencidos() {
            const hoje = new Date();
            clientesFiltrados = clientes.filter(cliente => {
                const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));
                const dataCliente = new Date(ano, mes - 1, dia);
                return dataCliente < hoje;
            });
            exibirTabela();
        }

        function filtrarDebito() {
            clientesFiltrados = clientes.filter(cliente => cliente.debito);
            exibirTabela();
        }

        function exibirTodos() {
            clientesFiltrados = [];
            exibirTabela();
        }

        function limparTodos() {
            clientes = [];
            clientesFiltrados = [];
            exibirTabela();
            salvarClientes();
        }

        function editar(index) {
    let listaParaEditar = clientesFiltrados.length > 0 ? clientesFiltrados : clientes;
    let cliente = listaParaEditar[index];

    // Criando o modal
    let modal = document.createElement("div");
    modal.id = "modalEdicao";
    modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center;">
            <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; width: 300px;">
                <h3>Editar Cliente</h3>
                <input type="text" id="novoNome" value="${cliente.nome}" placeholder="Nome"><br><br>
                <input type="tel" id="novoTelefone" value="${cliente.telefone}" placeholder="Telefone"><br><br>
                <input type="date" id="novaData" value="${formatarParaInputDate(cliente.data)}"><br><br>

                <!-- Sele√ß√£o do Produto -->
                <div>
                    <label>
                        <input type="radio" name="editarProduto" value="UniTv" ${cliente.Produto === "UniTv" ? "checked" : ""}> UniTv
                    </label>
                    <label>
                        <input type="radio" name="editarProduto" value="Duplecast" ${cliente.Produto === "Duplecast" ? "checked" : ""}> Duplecast
                    </label>
                </div>
                <br>

                <button id="salvarBtn">Salvar</button>
                <button onclick="fecharModal()">Cancelar</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // Focar no primeiro campo automaticamente
    document.getElementById("novoNome").focus();

    // Adicionar eventos de teclado
    document.getElementById("novoNome").addEventListener("keydown", (e) => proximoCampo(e, "novoTelefone"));
    document.getElementById("novoTelefone").addEventListener("keydown", (e) => proximoCampo(e, "novaData"));
    document.getElementById("novaData").addEventListener("keydown", (e) => verificarProdutoESalvar(e, index));

    // Adicionar evento Enter no √∫ltimo campo para salvar
    document.querySelectorAll('input[name="editarProduto"]').forEach(input => {
        input.addEventListener("keydown", (e) => salvarComEnter(e, index));
    });

    // Bot√£o de salvar com clique
    document.getElementById("salvarBtn").addEventListener("click", () => salvarEdicao(index));

    // Fechar modal com ESC
    document.addEventListener("keydown", fecharComEsc);
}

// Fun√ß√£o para pular para o pr√≥ximo campo ao pressionar Enter
function proximoCampo(event, proximoId) {
    if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById(proximoId)?.focus();
    }
}

// Fun√ß√£o para verificar se um produto est√° selecionado e salvar automaticamente
function verificarProdutoESalvar(event, index) {
    if (event.key === "Enter") {
        const produtoSelecionado = document.querySelector('input[name="editarProduto"]:checked');
        if (produtoSelecionado) {
            salvarEdicao(index);
        }
    }
}

// Fun√ß√£o para salvar ao pressionar Enter no √∫ltimo campo
function salvarComEnter(event, index) {
    if (event.key === "Enter") {
        salvarEdicao(index);
    }
}

// Fun√ß√£o para salvar a edi√ß√£o
function salvarEdicao(index) {
    let listaParaEditar = clientesFiltrados.length > 0 ? clientesFiltrados : clientes;
    let cliente = listaParaEditar[index];

    let novoNome = document.getElementById("novoNome").value;
    let novoTelefone = document.getElementById("novoTelefone").value;
    let novaData = document.getElementById("novaData").value;
    let novoProduto = document.querySelector('input[name="editarProduto"]:checked').value; // Obt√©m o novo produto

    if (!novoNome || !novaData) {
        alert("Nome e data s√£o obrigat√≥rios!");
        return;
    }

    cliente.nome = novoNome;
    cliente.telefone = novoTelefone;
    cliente.data = novaData.split("-").reverse().join("/");
    cliente.Produto = novoProduto; // Atualiza o produto

    exibirTabela();
    salvarClientes();
    fecharModal();
}

// Fun√ß√£o para converter "DD/MM/AAAA" para "AAAA-MM-DD"
function formatarParaInputDate(data) {
    let [dia, mes, ano] = data.split("/");
    return `${ano}-${mes}-${dia}`;
}

// Fechar modal corretamente
function fecharModal() {
    let modal = document.getElementById("modalEdicao");
    if (modal) {
        document.body.removeChild(modal);
        document.removeEventListener("keydown", fecharComEsc); // Remove o evento do ESC ao fechar
    }
}

// Fun√ß√£o para fechar o modal ao pressionar ESC
function fecharComEsc(event) {
    if (event.key === "Escape") {
        fecharModal();
    }
}


// Fun√ß√£o para pular para o pr√≥ximo campo ao pressionar Enter
function proximoCampo(event, proximoId) {
    if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById(proximoId)?.focus();
    }
}

// Fun√ß√£o para salvar ao pressionar Enter no √∫ltimo campo
function salvarComEnter(event, index) {
    if (event.key === "Enter") {
        salvarEdicao(index);
    }
}

// Fun√ß√£o para salvar a edi√ß√£o
function salvarEdicao(index) {
    let listaParaEditar = clientesFiltrados.length > 0 ? clientesFiltrados : clientes;
    let cliente = listaParaEditar[index];

    let novoNome = document.getElementById("novoNome").value;
    let novoTelefone = document.getElementById("novoTelefone").value;
    let novaData = document.getElementById("novaData").value;
    let novoProduto = document.querySelector('input[name="editarProduto"]:checked').value; // Obt√©m o novo produto

    if (!novoNome || !novaData) {
        alert("Nome e data s√£o obrigat√≥rios!");
        return;
    }

    cliente.nome = novoNome;
    cliente.telefone = novoTelefone;
    cliente.data = novaData.split("-").reverse().join("/");
    cliente.Produto = novoProduto; // Atualiza o produto

    exibirTabela();
    salvarClientes();
    fecharModal();
}


// Fun√ß√£o para converter "DD/MM/AAAA" para "AAAA-MM-DD"
function formatarParaInputDate(data) {
    let [dia, mes, ano] = data.split("/");
    return `${ano}-${mes}-${dia}`;
}

function copiarMensagem(index) {
    let cliente = clientes[index];

    const telefoneLimpo = cliente.telefone.replace(/\D/g, ''); // Remove tudo que n√£o for n√∫mero
    const dataAtual = new Date();
    const hora = dataAtual.getHours();

    let saudacao = "Ol√°"; 
    if (hora >= 6 && hora < 12) {
        saudacao = "Bom dia";
    } else if (hora >= 12 && hora < 18) {
        saudacao = "Boa tarde";
    } else {
        saudacao = "Boa noite";
    }

    const mensagem = `
${saudacao}!
Hoje √© o vencimento do seu plano de TV.

Vencimento: ${dataAtual.toLocaleDateString('pt-BR')}

O pagamento via PIX pode ser realizado no n√∫mero: 
11950912509 (Waldemar Jose Luiz)
`;

    // Usando API moderna para copiar para a √°rea de transfer√™ncia
    navigator.clipboard.writeText(mensagem).then(() => {
        alert("Mensagem copiada para a √°rea de transfer√™ncia!");
    }).catch(err => {
        console.error("Erro ao copiar:", err);
        alert("Falha ao copiar. Tente manualmente.");
    });
}

// Fechar modal corretamente
function fecharModal() {
    let modal = document.getElementById("modalEdicao");
    if (modal) {
        document.body.removeChild(modal);
        document.removeEventListener("keydown", fecharComEsc); // Remove o evento do ESC ao fechar
    }
}

// Fun√ß√£o para mover para o pr√≥ximo campo ao pressionar Enter
function proximoCampo(event, proximoId) {
    if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById(proximoId).focus();
    }
}

// Fun√ß√£o para salvar ao pressionar Enter no campo de data
function salvarComEnter(event, index) {
    if (event.key === "Enter") {
        salvarEdicao(index);
    }
}

// Fun√ß√£o para fechar o modal ao pressionar ESC
function fecharComEsc(event) {
    if (event.key === "Escape") {
        fecharModal();
    }
}

function excluir(index) {
    let listaParaEditar = clientesFiltrados.length > 0 ? clientesFiltrados : clientes;
    let cliente = listaParaEditar[index];

    // Encontrar o √≠ndice correto na lista principal
    clienteIndexParaExcluir = clientes.findIndex(c => c.nome === cliente.nome && c.data === cliente.data);

    if (clienteIndexParaExcluir !== -1) {
        document.getElementById("modalExclusao").style.display = "flex"; // Exibe o modal
    }
}



        function toggleAvisado(index) {
    let listaParaEditar = clientesFiltrados.length > 0 ? clientesFiltrados : clientes;
    let cliente = listaParaEditar[index];

    // Encontra o cliente correspondente na lista principal
    let clienteOriginal = clientes.find(c => c.nome === cliente.nome && c.data === cliente.data);
    if (clienteOriginal) {
        clienteOriginal.avisado = !clienteOriginal.avisado;
    }

    exibirTabela();
    salvarClientes();
}

function toggleDebito(index) {
    let listaParaEditar = clientesFiltrados.length > 0 ? clientesFiltrados : clientes;
    let cliente = listaParaEditar[index];

    // Encontra o cliente correspondente na lista principal
    let clienteOriginal = clientes.find(c => c.nome === cliente.nome && c.data === cliente.data);
    if (clienteOriginal) {
        clienteOriginal.debito = !clienteOriginal.debito;
    }

    exibirTabela();
    salvarClientes();
}


        function renovar30(index) {
            const cliente = clientesFiltrados.length > 0 ? clientesFiltrados[index] : clientes[index];
            cliente.data = incrementarData(cliente.data, 30);
            if (clientesFiltrados.length > 0) clientesFiltrados.splice(index, 1);
            exibirTabela();
            salvarClientes();
        }

        function renovarProximoMes(index) {
            const cliente = clientesFiltrados.length > 0 ? clientesFiltrados[index] : clientes[index];
            const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));
            const dataObj = new Date(ano, mes - 1, dia);

            dataObj.setMonth(dataObj.getMonth() + 1);
            
            if (dataObj.getDate() !== dia) {
                dataObj.setDate(0);
            }

            cliente.data = `${dataObj.getDate().toString().padStart(2, '0')}/${(dataObj.getMonth() + 1).toString().padStart(2, '0')}/${dataObj.getFullYear()}`;
            
            if (clientesFiltrados.length > 0) clientesFiltrados.splice(index, 1);
            exibirTabela();
            salvarClientes();
        }

        

        function incrementarData(data, dias) {
            const [dia, mes, ano] = data.split("/").map(num => parseInt(num));
            const dataObj = new Date(ano, mes - 1, dia);
            dataObj.setDate(dataObj.getDate() + dias);
            return `${dataObj.getDate().toString().padStart(2, '0')}/${(dataObj.getMonth() + 1).toString().padStart(2, '0')}/${dataObj.getFullYear()}`;
        }

        function salvarClientes() {
            localStorage.setItem('clientes', JSON.stringify(clientes));
        }

        function salvarArquivo() {
            const data = JSON.stringify(clientes, null, 4);
            const blob = new Blob([data], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'clientes.json';
            link.click();
        }

        function importarClientes() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = () => {
            try {
                const clientesImportados = JSON.parse(reader.result);

                // Garante que cada cliente importado tenha o campo Produto
                const clientesCorrigidos = clientesImportados.map(cliente => ({
                    data: cliente.data,
                    nome: cliente.nome,
                    telefone: cliente.telefone,
                    avisado: cliente.avisado,
                    debito: cliente.debito,
                    Produto: cliente.Produto || "N√£o informado" // Se n√£o existir, define como "N√£o informado"
                }));

                // Adiciona os clientes importados √† lista existente
                clientes = [...clientes, ...clientesCorrigidos];

                // Atualiza a tabela e salva os dados
                exibirTabela();
                salvarClientes();
                alert("Clientes importados com sucesso!");
            } catch (error) {
                alert("Erro ao importar JSON. Verifique o arquivo.");
            }
        };
        reader.readAsText(file);
    };
    input.click();
}




        function compartilharWhatsApp() {
            const url = `https://wa.me/?text=${encodeURIComponent('Ol√°, estou compartilhando esta lista de clientes com voc√™.')}`;
            window.open(url, '_blank');
        }

        document.getElementById('dataAtual').innerText = new Date().toLocaleDateString('pt-BR');
        exibirTabela();
    </script>
</body>
</html>
